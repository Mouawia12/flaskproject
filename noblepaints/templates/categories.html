{% extends 'sec.html' %}

{% macro render_category(category, lang, inverse=False) -%}
    {% set name = category.name if lang == 'en' else category.nameArabic or category.name %}
    {% set description = (category.desc or '') | safe %}
    {% set button_label = 'Browse Products' if lang == 'en' else 'تصفح المنتجات' %}
    {% set image_src = category.img or '/static/images/default.png' %}
    <article class="category-card toLangRep hidden{% if inverse %} category-card--reverse{% endif %}" data-lang="{{ lang }}" lang="{{ lang }}">
        <div class="category-card__inner">
            <div class="category-card__image">
                <img src="{{ image_src }}" alt="{{ name }}" class="lazy-image loaded" loading="lazy" decoding="async" onerror="this.src='/static/images/default.png'">
            </div>
            <div class="category-card__content">
                <span class="category-card__tag">{{ 'الفئة' if lang == 'ar' else t('categories.tag', 'Collection') }}</span>
                <h3 class="category-card__title">{{ name }}</h3>
                <div class="category-card__text-wrapper">
                    <p class="category-card__text{% if lang == 'ar' %} text5{% endif %}">{{ description }}</p>
                </div>
                <div class="category-card__actions">
                    <a href="/productsSearch/?category={{ category.id }}&page=1" class="btn btn-outline-primary toRep3">{{ button_label }}</a>
                </div>
                {% if category.id == 20 %}
                    <div class="category-card__extras">
                        <img src="/static/images/all.jpg" alt="All products" class="lazy-image loaded" loading="lazy" decoding="async" onerror="this.src='/static/images/default.png'">
                    </div>
                {% endif %}
            </div>
        </div>
    </article>
{%- endmacro %}

{% block head %}
<!-- Preload critical CSS -->
<link rel="preload" href="/static/css/products.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/static/css/products.css"></noscript>
<link rel="preload" href="/static/css/props.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/static/css/props.css"></noscript>
<link rel="stylesheet" href="/static/css/categories.css">

<!-- Load external resources efficiently -->
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://netdna.bootstrapcdn.com">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"></noscript>
<link href="//netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome.css" rel="stylesheet" media="print" onload="this.media='all'">
<noscript><link href="//netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome.css" rel="stylesheet"></noscript>
{% endblock %}

{% block content %}
<header class="page-hero page-hero--categories" role="banner">
    <div class="page-hero__overlay" aria-hidden="true"></div>
    <div class="container2">
        <nav class="page-hero__breadcrumbs" aria-label="{{ t('aria.breadcrumbs', 'Breadcrumb') }}">
            <a href="{{ url_for_lang('home_page') }}" class="page-hero__breadcrumb-home">
                <svg aria-hidden="true" focusable="false" data-prefix="fal" data-icon="home-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M541 229.16l-232.85-190a32.16 32.16 0 0 0-40.38 0L35 229.16a8 8 0 0 0-1.16 11.24l10.1 12.41a8 8 0 0 0 11.2 1.19L96 220.62v243a16 16 0 0 0 16 16h128a16 16 0 0 0 16-16v-128l64 .3V464a16 16 0 0 0 16 16l128-.33a16 16 0 0 0 16-16V220.62L520.86 254a8 8 0 0 0 11.25-1.16l10.1-12.41a8 8 0 0 0-1.21-11.27zM447.89 447.75h.1l-96 .3V319.88a16.05 16.05 0 0 0-15.95-16l-96-.27a16 16 0 0 0-16.05 16v128.14H128V194.51L288 63.94l160 130.57z"></path></svg>
                <span>{{ t('nav.home', 'Home') }}</span>
            </a>
            <span class="page-hero__divider" aria-hidden="true"></span>
            <span>{{ t('nav.categories', 'Categories') }}</span>
        </nav>
        <div class="page-hero__content">
            <span class="page-hero__eyebrow">{{ t('categories.hero.eyebrow', 'Product families') }}</span>
            <h1 class="page-hero__title">{{ t('nav.categories', 'Categories') }}</h1>
            <p class="page-hero__subtitle">{{ t('categories.hero.subtitle', 'Explore Noble Paints collections to quickly find the coating system that matches your project.') }}</p>
        </div>
    </div>
</header>

<section class="section section--light">
    <div class="container2">
        <div class="category-intro">
            <h2 class="category-intro__title">{{ t('categories.intro.title', 'Browse by solution') }}</h2>
            <p class="category-intro__text">{{ t('categories.intro.subtitle', 'Each category groups together coatings designed for a specific environment or application.') }}</p>
        </div>

        <div id="categories-loading" class="category-status" role="status" aria-live="polite">
            <span class="category-status__spinner" aria-hidden="true"></span>
            <p>{{ t('categories.loading', 'Loading categories...') }}</p>
        </div>

        <div id="categories-error" class="category-status category-status--error" role="alert" hidden>
            <p>{{ t('categories.error', 'Unable to load categories at the moment.') }}</p>
            <button type="button" class="btn btn-outline-primary" data-categories-retry>{{ t('categories.retry', 'Try again') }}</button>
        </div>

        <div id="categories-content" class="category-list" hidden>
            {% if categories and categories|length > 0 %}
                {% for cat in categories %}
                    {{ render_category(cat, 'en', loop.index0 % 2 == 1) }}
                {% endfor %}
                {% for cat in categories %}
                    {{ render_category(cat, 'ar', loop.index0 % 2 == 1) }}
                {% endfor %}
            {% else %}
                <div class="category-empty">
                    <h3>{{ t('categories.empty.title', 'No categories available yet') }}</h3>
                    <p>{{ t('categories.empty.subtitle', 'We are preparing our catalogue. Please check back shortly for the latest categories.') }}</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js" defer></script>
<script src="/static/js/languages/categories.js"></script>
<script src="/static/js/categories.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const categoriesLoading = document.getElementById('categories-loading');
    const categoriesContent = document.getElementById('categories-content');
    const categoriesError = document.getElementById('categories-error');
    const retryButton = document.querySelector('[data-categories-retry]');

    const toggleState = ({ loading = false, error = false }) => {
        if (categoriesLoading) {
            categoriesLoading.hidden = !loading;
        }
        if (categoriesError) {
            categoriesError.hidden = !error;
        }
        if (categoriesContent) {
            categoriesContent.hidden = loading || error;
        }
    };

    const showContent = () => {
        toggleState({ loading: false, error: false });
        window.requestAnimationFrame(() => initializeLazyLoading());
        updateLanguageVisibility();
    };

    const showError = () => toggleState({ loading: false, error: true });

    const hasExistingContent = () => {
        return categoriesContent && categoriesContent.querySelectorAll('.category-card').length > 0;
    };

    if (retryButton) {
        retryButton.addEventListener('click', () => loadCategories(true));
    }

    if (hasExistingContent()) {
        showContent();
        window.setTimeout(() => loadCategories(false), 800);
    } else {
        loadCategories(false);
    }

    function updateLanguageVisibility() {
        if (!categoriesContent) {
            return;
        }
        const items = Array.from(categoriesContent.querySelectorAll('.toLangRep'));
        if (!items.length) {
            return;
        }
        const currentLang = (window.getCurrentLang && window.getCurrentLang()) || localStorage.getItem('nobleLang') || 'en';
        items.forEach((item) => {
            const itemLang = item.getAttribute('lang') || item.dataset.lang;
            if (itemLang === currentLang) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }

    async function loadCategories(forceReload) {
        const existingCount = hasExistingContent() ? categoriesContent.querySelectorAll('.category-card').length : 0;
        if (!existingCount || forceReload) {
            toggleState({ loading: true, error: false });
        }
        try {
            const response = await fetch('/api/categories/');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (!data.success || !Array.isArray(data.categories) || data.categories.length === 0) {
                if (!existingCount) {
                    showError();
                } else {
                    showContent();
                }
                return;
            }
            if (!existingCount || data.count * 2 > existingCount) {
                renderCategories(data.categories);
            } else {
                showContent();
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            if (!existingCount) {
                showError();
            } else {
                showContent();
            }
        }
    }

    function renderCategories(categories) {
        if (!categoriesContent) {
            return;
        }
        const htmlParts = [];
        categories.forEach((category, index) => {
            htmlParts.push(generateCategoryHTML(category, 'en', index % 2 === 1));
        });
        categories.forEach((category, index) => {
            htmlParts.push(generateCategoryHTML(category, 'ar', index % 2 === 1));
        });
        categoriesContent.innerHTML = htmlParts.join('');
        showContent();
        window.setTimeout(updateLanguageVisibility, 0);
    }

    function generateCategoryHTML(category, lang, isInverse) {
        const name = lang === 'ar' ? (category.nameArabic || category.name || '') : (category.name || '');
        const description = category.desc || '';
        const buttonLabel = lang === 'ar' ? 'تصفح المنتجات' : 'Browse Products';
        const imageSrc = category.img || '/static/images/default.png';
        const textClass = lang === 'ar' ? 'category-card__text text5' : 'category-card__text';
        const extraImage = category.id === 20 ? `
            <div class="category-card__extras">
                <img src="/static/images/all.jpg" alt="All products" class="lazy-image loaded" loading="lazy" decoding="async" onerror="this.src='/static/images/default.png'">
            </div>
        ` : '';
        return `
            <article class="category-card toLangRep hidden${isInverse ? ' category-card--reverse' : ''}" lang="${lang}" data-lang="${lang}">
                <div class="category-card__inner">
                    <div class="category-card__image">
                        <img src="${imageSrc}" alt="${name || 'Category'}" class="lazy-image loaded" loading="lazy" decoding="async" onerror="this.src='/static/images/default.png'">
                    </div>
                    <div class="category-card__content">
                        <span class="category-card__tag">${lang === 'ar' ? 'الفئة' : 'Collection'}</span>
                        <h3 class="category-card__title">${name || 'Unnamed Category'}</h3>
                        <div class="category-card__text-wrapper">
                            <p class="${textClass}">${description || ''}</p>
                        </div>
                        <div class="category-card__actions">
                            <a href="/productsSearch/?category=${category.id}&page=1" class="btn btn-outline-primary toRep3">${buttonLabel}</a>
                        </div>
                        ${extraImage}
                    </div>
                </div>
            </article>
        `;
    }

    window.loadCategories = loadCategories;
});
</script>
{% endblock %}
